<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Degen Idle - Live XP & Crafting Calculator</title>
<style>
:root{
  --bg:#0b0f14; --panel:#0f1720; --muted:#9aa6b2; --accent:#f6c45e;
  --card:#121722; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{margin:0; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,#06080b 0%, #07111b 100%); color:#e6eef6; min-height:100vh}
.container{max-width:1100px;margin:28px auto;padding:20px}
.header{display:flex;align-items:center;gap:16px; margin-bottom:20px}
.logo{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,#132433,#2c2a3f);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);box-shadow:0 6px 24px rgba(0,0,0,0.6)}
.title{font-size:20px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03)}
.controls label{display:block;color:var(--muted);font-size:12px;margin-top:12px; margin-bottom:4px}
.controls select,input{width:100%;padding:10px;margin-top:4px;border-radius:8px;background:rgba(255,255,255,0.05);color:inherit;border:1px solid rgba(255,255,255,0.1); font-size:14px}
.controls select{background:rgba(15, 23, 32, 0.8) !important; color:#e6eef6 !important;}
.btn{background:linear-gradient(90deg,var(--accent),#ffb86b);border:none;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;margin-top:16px; width:100%; color:#0b0f14; font-size:14px}
.btn:active{transform:translateY(1px)}
.result{padding:12px;margin-top:14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); font-size:13px}
.row{display:flex;gap:10px;align-items:center}
.small{font-size:13px;color:var(--muted)}
.tile{padding:12px;border-radius:8px;background:var(--glass);display:flex;align-items:center;justify-content:space-between; margin-bottom:8px}
.output{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:12px}
.code{background:#07111b;padding:12px;border-radius:8px;font-family:'Monaco','Consolas',monospace;color:#bfe0ff;font-size:12px; line-height:1.4; white-space:pre-wrap}
.footer{margin-top:24px;color:var(--muted);font-size:13px; text-align:center}
.sheet-input{background:rgba(255,255,255,0.03)!important; font-size:12px!important; padding:8px!important; font-family:monospace}
.success{color:#6bff87}
.error{color:#ff6b6b}
.efficiency-input{width:80px !important; display:inline-block !important; margin-left:8px !important}
@media (max-width:720px){
  .container{padding:12px;margin:12px auto}
  .grid{grid-template-columns:1fr;gap:12px}
  .logo{width:48px;height:48px}
  .controls select,input{font-size:16px;padding:12px}
  .btn{position:static; margin-top:20px}
  .output{margin-bottom:20px}
  .header{flex-direction:column; text-align:center; gap:12px}
  .efficiency-input{width:70px !important}
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">DI</div>
    <div>
      <div class="title">Degen Idle — The greatest calculator you'll see today..</div>
      <div class="small">This is an unofficial exp calculator so go complain elsewhere, with love.</div>
    </div>
  </div>

  <div class="grid">
    <div class="card controls">
      <input type="text" id="sheetId" class="sheet-input" style="display:none" />
      <div class="small" style="opacity:0.7; margin:8px 0">Data status: <span id="dataStatus">Loading...</span></div>

      <label>Skill</label>
      <select id="skillSelect"><option value="">Loading skills...</option></select>

      <div style="display:flex;gap:8px;margin-top:12px">
        <div style="flex:1">
          <label>Current Level</label>
          <input id="lvlCurrent" type="number" value="1" min="1" max="99" />
        </div>
        <div style="width:120px">
          <label>Target Level</label>
          <input id="lvlTarget" type="number" value="10" min="2" max="99" />
        </div>
      </div>

      <label>Choose strategy</label>
      <select id="strategy">
        <option value="xp_per_hour">Highest XP / hour</option>
        <option value="least_resources">Least Resources</option>
        <option value="newest">Newest unlocked item</option>
      </select>

      <div style="margin-top:12px">
        <label>
          Efficiency
          <input id="efficiency" type="number" class="efficiency-input" value="100" min="1" max="1000" step="0.01" />
          %
        </label>
      </div>

      <button class="btn" id="calcBtn">Calculate</button>
      <div class="result" id="status">Loading data from sheet...</div>
    </div>

    <div class="card">
      <div class="row">
        <h3 style="margin:0">Results</h3>
        <div style="margin-left:auto" class="small">Outputs: Resources • Time</div>
      </div>

      <div class="output">
        <div class="tile">
          <div>
            <div class="small">Crafted Items Needed</div>
            <div id="outItems" style="font-weight:700;font-size:18px">—</div>
            <div id="outCraftedItem" class="small" style="margin-top:4px">—</div>
          </div>
          <div>
            <div class="small">Total Time Required</div>
            <div id="outTime" style="font-weight:700;font-size:18px">—</div>
            <div id="outTimeBase" class="small" style="margin-top:4px">—</div>
          </div>
        </div>

        <div class="tile">
          <div style="width:100%">
            <div class="small">Resource Totals</div>
            <div id="outResources" class="small code">—</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    Dreams made it come true
    <br><em style="opacity:0.8">That's a pun btw since I'm Dreams and all</em>
  </div>
</div>

<script>
// 1. Sheet ID configuration
const DEFAULT_SHEET_ID = "1CT8MUByrq8Cpd7qBWQiE9PMxhdYEvwY_FiQGYr_8KeI";
const TAB_EXP = "Exp values", TAB_SKILLS = "Skills", TAB_RECIPES = "Recipes";

const DATA = { levels: [], items: [], recipes: [], itemNameMap: {} };
const el = id => document.getElementById(id);

// 2. CSV parsing utility
const csvToRows = csv => {
  const rows = [];
  let row = [], cur = "", inside = false;
  for (let c of csv) {
    if (c === '"' && !inside) { inside = true; continue; }
    if (c === '"' && inside) { inside = false; continue; }
    if (c === ',' && !inside) { row.push(cur); cur = ""; continue; }
    if (c === '\n' && !inside) { row.push(cur); rows.push(row); row = []; cur = ""; continue; }
    cur += c;
  }
  if (cur) row.push(cur);
  if (row.length) rows.push(row);
  return rows.map(r => r.map(v => v.trim()));
};

const gvizCsvUrl = (id, tab) =>
  `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;

async function fetchTab(id, name) {
  const r = await fetch(gvizCsvUrl(id, name));
  return csvToRows(await r.text());
}

// 3. Load all tabs from sheet
async function loadAll(id) {
  try {
    // Exp tab
    const exp = await fetchTab(id, TAB_EXP);
    DATA.levels = exp.slice(1).map(r => ({ level: +r[0], xp: +r[1] })).filter(x => !isNaN(x.level));

    // Skills tab
    const skills = await fetchTab(id, TAB_SKILLS);
    const sh = skills[0], idx = h => sh.indexOf(h);

    // DEBUG: Show raw skills data
    console.log("RAW SKILLS DATA:");
    console.log("Headers:", sh);
    skills.slice(1, 6).forEach((row, i) => {
      console.log(`Row ${i}:`, row);
    });

    DATA.items = skills.slice(1).map(r => {
      const itemId = String(r[idx("Item")]);
      const name = itemId;
      DATA.itemNameMap[itemId] = name;
      return {
        skill: r[idx("Skill")],
        id: itemId,
        name,
        minLvl: +r[idx("MinLvl")] || 1,
        maxLvl: +r[idx("MaxLvl")] || 99,
        xpPer: +r[idx("XPPerItem")] || 0,
        timeSec: +r[idx("TimeSec")] || 1,
        outQty: +r[idx("OutputQty")] || 1
      };
    }).filter(x => x.skill);

    // Recipes tab
    const recipes = await fetchTab(id, TAB_RECIPES);
    const rh = recipes[0];
    DATA.recipes = recipes.slice(1).map(row => {
      let obj = {};
      rh.forEach((col, i) => { obj[col.trim()] = row[i] ? row[i].trim() : ""; });
      return obj;
    });

    // DEBUG: Check what's actually in the recipes
    console.log("Recipes tab raw data:");
    console.log("Headers:", rh);
    DATA.recipes.slice(0, 3).forEach((recipe, i) => {
      console.log(`Recipe ${i}:`, recipe);
    });

    // Extra display name mapping from all sources
    skills.slice(1).forEach(r => {
      const itemId = String(r[idx("Item")]);
      const name = String(r[idx("DisplayName")] || r[idx("Name")] || itemId);
      if (!DATA.itemNameMap[itemId]) DATA.itemNameMap[itemId] = name;
    });

    DATA.recipes.forEach(r => {
      if (r["Item"] && !DATA.itemNameMap[r["Item"]]) DATA.itemNameMap[r["Item"]] = r["Item"];
      for (let i = 1; i <= 3; ++i) {
        if (r[`Ingredient ${i}`] && !DATA.itemNameMap[r[`Ingredient ${i}`]]) {
          DATA.itemNameMap[r[`Ingredient ${i}`]] = r[`Ingredient ${i}`];
        }
      }
    });

    el("dataStatus").textContent = "Ready ✓";
    el("dataStatus").className = "success";

    // Populate the skills dropdown
    const skillsSet = [...new Set(DATA.items.map(i => i.skill))].sort();
    const sel = el("skillSelect");
    sel.innerHTML = "";
    skillsSet.forEach(s => {
      const o = document.createElement("option");
      o.value = s; o.textContent = s;
      sel.appendChild(o);
    });

  } catch (e) {
    el("dataStatus").textContent = "Error loading data";
    el("dataStatus").className = "error";
    console.error(e);
  }
}

// 4. Utility functions
const xp = l => (DATA.levels.find(x => x.level === l) || {}).xp || 0;
const itemsAt = (skill, l) => DATA.items.filter(i => i.skill === skill && l >= i.minLvl && l <= i.maxLvl);

const best = (skill, l, str) => {
  const c = itemsAt(skill, l);
  if (!c.length) return null;
  if (str === "newest") return c.reduce((a, b) => b.minLvl > a.minLvl ? b : a);
  if (str === "xp_per_hour") return c.reduce((a, b) => (b.xpPer / b.timeSec) > (a.xpPer / a.timeSec) ? b : a);
  return c[0];
};

// 5. Resource breakdown: recursive ingredient mapping
function getRecipeIngredients(itemName, qtyNeeded, recipesArr, itemNameMap) {
  // Convert to string for consistent lookup
  const lookupName = String(itemName);
  
  let recipeRow = recipesArr.find(r =>
    r["Item"] && String(r["Item"]).trim().toLowerCase() === lookupName.trim().toLowerCase()
  );
  
  if (!recipeRow) {
    // If no recipe, treat as raw resource - USE DISPLAY NAME
    let display = itemNameMap[lookupName] || itemNameMap[itemName] || itemName;
    return { [display]: qtyNeeded };
  }

  let breakdown = {};
  for (let i = 1; i <= 3; ++i) {
    let ingr = recipeRow[`Ingredient ${i}`];
    let qty = recipeRow[`Qty ${i}`];
    if (ingr && qty) {
      ingr = String(ingr).trim();
      let ingrTotal = qtyNeeded * Number(qty);
      // Recursively resolve ingredient
      let result = getRecipeIngredients(ingr, ingrTotal, recipesArr, itemNameMap);
      // Merge the results with proper display names
      for (let k in result) {
        breakdown[k] = (breakdown[k] || 0) + result[k];
      }
    }
  }
  return breakdown;
}

// Enhanced debug: Check what's really happening
function debugItemNames() {
  console.log("=== DEBUG ITEM NAMES ===");
  
  // Check Skills tab items
  console.log("Skills items sample:", DATA.items.slice(0, 5));
  
  // Check Recipes tab
  console.log("Recipes sample:", DATA.recipes.slice(0, 3));
  
  // Check specific item name mappings
  console.log("ItemNameMap sample:", Object.entries(DATA.itemNameMap).slice(0, 10));
  
  // Check if recipe ingredients exist in the name map
  if (DATA.recipes.length > 0) {
    const firstRecipe = DATA.recipes[0];
    console.log("First recipe analysis:");
    console.log(" - Main item:", firstRecipe["Item"], "->", DATA.itemNameMap[firstRecipe["Item"]]);
    for (let i = 1; i <= 3; i++) {
      const ing = firstRecipe[`Ingredient ${i}`];
      if (ing) {
        console.log(` - Ingredient ${i}:`, ing, "->", DATA.itemNameMap[ing]);
      }
    }
  }
  console.log("=== END DEBUG ===");
}

// Debug the itemNameMap lookup specifically
function debugNameLookup() {
  console.log("=== ITEM NAME MAP LOOKUP DEBUG ===");
  
  // Check what's actually in the itemNameMap
  console.log("Full itemNameMap contents:");
  Object.entries(DATA.itemNameMap).forEach(([key, value]) => {
    console.log(`  "${key}" -> "${value}" (type: ${typeof value})`);
  });
  
  // Test lookup for the specific ingredients we saw in debug
  const testItems = ["copper ore", "coal ore", "1", "30"];
  testItems.forEach(item => {
    const result = DATA.itemNameMap[item];
    console.log(`Lookup "${item}":`, result, `(type: ${typeof result})`);
  });
  
  console.log("=== END LOOKUP DEBUG ===");
}

// 6. Main calculation
function runCalc() {
  debugItemNames();
  debugNameLookup();
  const skill = el("skillSelect").value;
  const cur = +el("lvlCurrent").value;
  const tgt = +el("lvlTarget").value;
  const strat = el("strategy").value;
  const eff = +el("efficiency").value;

  if (!skill) return alert("Pick a skill first!");

  let totalItems = 0, totalTime = 0, baseTime = 0, lastItem = "";
  let craftedItemName = "";

  for (let L = cur; L < tgt; L++) {
    const it = best(skill, L, strat) || best(skill, L + 1, strat);
    if (!it) continue;
    const need = Math.ceil((xp(L + 1) - xp(L)) / it.xpPer);
    totalItems += need;
    lastItem = it.name;
    baseTime += need * it.timeSec;
    const effTime = it.timeSec * (100 / Math.max(eff, 0.1));
    totalTime += need * effTime;
    craftedItemName = it.id;
  }

  el("outItems").textContent = totalItems.toLocaleString();
  el("outCraftedItem").textContent = lastItem ? `(${lastItem})` : "";
  el("outTime").textContent = formatTime(totalTime);
  el("outTimeBase").textContent = eff !== 100 ? `Base: ${formatTime(baseTime)}` : "";

  // Resource breakdown display
  if (craftedItemName) {
    let resourceTotals = getRecipeIngredients(craftedItemName, totalItems, DATA.recipes, DATA.itemNameMap);
    
    // Debug resource display
    console.log("RAW resourceTotals:", resourceTotals);
    el("outResources").textContent = Object.entries(resourceTotals)
      .map(([name, qty]) => {
        console.log(`Resource: "${name}" -> ${qty}`);
        return `${name}: ${qty.toLocaleString()}`;
      })
      .join("\n") || "None";
  } else {
    el("outResources").textContent = "None";
  }
  el("status").textContent = "Done ✅";
}

function formatTime(secs) {
  const total = Math.round(secs);
  const h = Math.floor(total / 3600);
  const m = Math.floor((total % 3600) / 60);
  const s = total % 60;
  if (h) return `${h}h ${m}m`;
  if (m) return `${m}m ${s}s`;
  return `${s}s`;
}

el("calcBtn").addEventListener("click", runCalc);
el("sheetId").value = DEFAULT_SHEET_ID;
loadAll(DEFAULT_SHEET_ID);
</script>
</body>
</html>