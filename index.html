<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Degen Idle - XP & Crafting Calculator (Auto progression + XP)</title>
<style>
:root{
  --bg:#0b0f14; --panel:#0f1720; --muted:#9aa6b2; --accent:#f6c45e;
  --card:#121722; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,#06080b 0%,#07111b 100%);color:#e6eef6;min-height:100vh}
.container{max-width:1100px;margin:28px auto;padding:20px}
.header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.logo{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,#132433,#2c2a3f);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);box-shadow:0 6px 24px rgba(0,0,0,0.6)}
.title{font-size:20px}
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
.controls label{display:block;color:var(--muted);font-size:12px;margin-top:12px;margin-bottom:4px}
.controls select,input{width:100%;padding:10px;margin-top:4px;border-radius:8px;background:rgba(255,255,255,0.05);color:inherit;border:1px solid rgba(255,255,255,0.1);font-size:14px}
.controls select{background:rgba(15,23,32,0.8)!important;color:#e6eef6!important}
.btn{background:linear-gradient(90deg,var(--accent),#ffb86b);border:none;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;margin-top:16px;width:100%;color:#0b0f14;font-size:14px}
.btn:active{transform:translateY(1px)}
.result{padding:12px;margin-top:14px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));font-size:13px}
.row{display:flex;gap:10px;align-items:center}
.small{font-size:13px;color:var(--muted)}
.tile{padding:12px;border-radius:8px;background:var(--glass);display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.output{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:12px}
.code{background:#07111b;padding:12px;border-radius:8px;font-family:'Monaco','Consolas',monospace;color:#bfe0ff;font-size:12px;line-height:1.4;white-space:pre-wrap}
.footer{margin-top:24px;color:var(--muted);font-size:13px;text-align:center}
.sheet-input{background:rgba(255,255,255,0.03)!important;font-size:12px!important;padding:8px!important;font-family:monospace}
.success{color:#6bff87}
.error{color:#ff6b6b}
.efficiency-input{width:80px!important;display:inline-block!important;margin-left:8px!important}
.breakCard{background:rgba(255,255,255,0.04);padding:10px 14px;border-radius:10px;margin-top:10px;box-shadow:0 3px 12px rgba(0,0,0,0.3)}
.breakCard strong{color:var(--accent)}
@media(max-width:720px){
.container{padding:12px;margin:12px auto}
.grid{grid-template-columns:1fr;gap:12px}
.logo{width:48px;height:48px}
.controls select,input{font-size:16px;padding:12px}
.btn{position:static;margin-top:20px}
.output{margin-bottom:20px}
.header{flex-direction:column;text-align:center;gap:12px}
.efficiency-input{width:70px!important}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">DI</div>
    <div>
      <div class="title">Degen Idle ‚Äî XP & Crafting Calculator</div>
      <div class="small">Manual or Auto progression ‚Ä¢ XP-based accuracy</div>
    </div>
  </div>

  <div class="grid">
    <div class="card controls">
      <input type="text" id="sheetId" class="sheet-input" style="display:none" />
      <div class="small" style="opacity:0.7;margin:8px 0">Data status: <span id="dataStatus">Loading...</span></div>

      <label>Skill</label>
      <select id="skillSelect"><option value="">Loading skills...</option></select>

      <div style="display:flex;gap:8px;margin-top:12px;align-items:flex-end">
        <div style="flex:1">
          <label><input type="checkbox" id="useLevel" /> Use Levels (instead of EXP)</label>
        </div>
      </div>

      <div id="levelInputs" style="margin-top:8px;display:none">
        <div style="display:flex;gap:8px">
          <div style="flex:1">
            <label>Current Level</label>
            <input id="lvlCurrent" type="number" value="1" min="1" max="99" />
          </div>
          <div style="width:120px">
            <label>Target Level</label>
            <input id="lvlTarget" type="number" value="10" min="2" max="99" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Current Level Progress (%)</label>
          <input id="lvlPercent" type="number" value="0" min="0" max="99.99" step="0.01" />
        </div>
      </div>

      <div id="xpInputs" style="margin-top:8px">
        <div style="display:flex;gap:8px">
          <div style="flex:1">
            <label>Current EXP</label>
            <input id="expCurrent" type="number" value="0" min="0" />
          </div>
          <div style="width:220px">
            <label>Target EXP</label>
            <input id="expTarget" type="number" value="10000" min="1" />
          </div>
        </div>
      </div>

      <label style="margin-top:12px">Select Recipe / Mode</label>
      <select id="recipeSelect"><option value="">Select a skill first</option></select>

      <div style="margin-top:12px">
        <label>
          Efficiency
          <input id="efficiency" type="number" class="efficiency-input" value="100" min="1" max="1000" step="0.01" />%
        </label>
      </div>

      <button class="btn" id="calcBtn">Calculate</button>
      <div class="result" id="status">Loading data from sheet...</div>
    </div>

    <div class="card">
      <div class="row">
        <h3 style="margin:0">Results</h3>
        <div style="margin-left:auto" class="small">Outputs: Breakdown ‚Ä¢ Totals ‚Ä¢ Resources</div>
      </div>

      <div class="output">
        <div class="tile" style="flex-direction:column;align-items:flex-start">
          <div class="small">Breakdown</div>
          <div id="outBreakdown" style="margin-top:8px;width:100%">‚Äî</div>
        </div>

        <div class="tile" style="flex-direction:column;align-items:flex-start">
          <div class="small">Totals</div>
          <div id="outTotals" style="font-weight:700;font-size:16px;margin-top:6px">‚Äî</div>
          <div id="outTimeBase" class="small" style="margin-top:6px">‚Äî</div>
        </div>

        <div class="tile" style="flex-direction:column;align-items:flex-start">
          <div class="small">Resource Totals</div>
          <div id="outResources" class="small code" style="margin-top:8px">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    Dreams made it come true üí§ ‚Äî Auto uses <strong>lowest time per XP</strong> per level unlock.
  </div>
</div>
<script>
const DEFAULT_SHEET_ID="1CT8MUByrq8Cpd7qBWQiE9PMxhdYEvwY_FiQGYr_8KeI";
const TAB_EXP="Exp values",TAB_SKILLS="Skills",TAB_RECIPES="Recipes";
const DATA={levels:[],items:[],recipes:[],itemNameMap:{}};
const el=id=>document.getElementById(id);

const csvToRows=csv=>{const rows=[];let row=[],cur="",inside=false;for(let c of csv){if(c=='"'&&!inside){inside=true;continue;}if(c=='"'&&inside){inside=false;continue;}if(c==','&&!inside){row.push(cur);cur="";continue;}if(c=='\n'&&!inside){row.push(cur);rows.push(row);row=[];cur="";continue;}cur+=c;}if(cur)row.push(cur);if(row.length)rows.push(row);return rows.map(r=>r.map(v=>v.trim()));};
const gvizCsvUrl=(id,tab)=>`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;
async function fetchTab(id,name){const r=await fetch(gvizCsvUrl(id,name));return csvToRows(await r.text());}

async function loadAll(id){try{const[exp,skills,recipes]=await Promise.all([fetchTab(id,TAB_EXP),fetchTab(id,TAB_SKILLS),fetchTab(id,TAB_RECIPES)]);DATA.levels=exp.slice(1).map(r=>({level:+r[0],xp:+r[1]})).filter(x=>!isNaN(x.level));
const sh=skills[0].map(h=>h.trim().toLowerCase());const f=h=>sh.findIndex(x=>x===h.toLowerCase());
DATA.items=skills.slice(1).map(r=>{const skill=r[f("skill")],item=r[f("item")];if(!skill||!item)return null;DATA.itemNameMap[item]=item;return{skill,id:item,name:item,minLvl:+r[f("minlvl")]||1,maxLvl:+r[f("maxlvl")]||99,xpPer:+r[f("xpperitem")]||0,timeSec:+r[f("timesec")]||1,outQty:+r[f("outputqty")]||1};}).filter(Boolean);
const rh=recipes[0];DATA.recipes=recipes.slice(1).map(r=>{const o={};rh.forEach((c,i)=>o[c.trim()]=r[i]?r[i].trim():"");return o;});
el("dataStatus").textContent="Ready ‚úì";el("dataStatus").className="success";
const skillsSet=[...new Set(DATA.items.map(i=>i.skill))].sort();const sel=el("skillSelect");sel.innerHTML="";const ph=document.createElement("option");ph.value="";ph.textContent="Select a skill";sel.appendChild(ph);
skillsSet.forEach(s=>{const o=document.createElement("option");o.value=s;o.textContent=s;sel.appendChild(o);});
el("skillSelect").addEventListener("change",updateRecipeDropdown);el("useLevel").addEventListener("change",toggleInputs);
el("lvlCurrent").addEventListener("change",updateRecipeDropdown);el("lvlTarget").addEventListener("change",updateRecipeDropdown);el("expCurrent").addEventListener("change",updateRecipeDropdown);el("expTarget").addEventListener("change",updateRecipeDropdown);
toggleInputs();}catch(e){console.error(e);el("dataStatus").textContent="Error loading data";el("dataStatus").className="error";}}

function toggleInputs(){const use=el("useLevel").checked;el("levelInputs").style.display=use?"block":"none";el("xpInputs").style.display=use?"none":"block";updateRecipeDropdown();}
function xpForLevel(l){return(DATA.levels.find(x=>x.level===l)||{}).xp||0;}
function levelToXP(l){return xpForLevel(l)||0;}
function expToLevel(exp){let lvl=1;for(const e of DATA.levels){if(exp>=e.xp)lvl=e.level;else break;}return lvl;}
function levelAndPercentToExp(level,percent){const cur=levelToXP(level);const next=levelToXP(level+1)||cur;return cur+(next-cur)*(Math.max(0,Math.min(100,percent))/100);}
function getRecipeIngredients(itemName,qty,recipes,map){const row=recipes.find(r=>r["Item"]&&r["Item"].trim().toLowerCase()===itemName.trim().toLowerCase());if(!row){const disp=map[itemName]||itemName;return{[disp]:qty};}
let res={};for(let i=1;i<=3;i++){const ingr=row[`Ingredient ${i}`],q=row[`Qty ${i}`];if(ingr&&q){const tot=qty*Number(q);const sub=getRecipeIngredients(ingr,tot,recipes,map);for(const k in sub)res[k]=(res[k]||0)+sub[k];}}return res;}

function updateRecipeDropdown(){const skill=el("skillSelect").value;const sel=el("recipeSelect");sel.innerHTML="";if(!skill)return sel.innerHTML="<option value=''>Select a skill</option>";
let curXP,tgtXP;if(el("useLevel").checked){const lvlCur=+el("lvlCurrent").value||1;const lvlPct=+el("lvlPercent").value||0;curXP=levelAndPercentToExp(lvlCur,lvlPct);const lvlTgt=+el("lvlTarget").value||lvlCur;tgtXP=levelToXP(lvlTgt);}else{curXP=+el("expCurrent").value||0;tgtXP=+el("expTarget").value||0;}
const curLevel=expToLevel(curXP);const tgtLevel=expToLevel(tgtXP);
const auto=document.createElement("option");auto.value="auto";auto.textContent="üîÅ Auto progression (lowest time per XP)";sel.appendChild(auto);
const avail=DATA.items.filter(i=>i.skill===skill&&i.minLvl<=tgtLevel&&i.maxLvl>=curLevel).sort((a,b)=>a.minLvl-b.minLvl);
if(!avail.length)return sel.innerHTML="<option value=''>No recipes unlocked in this range</option>";
avail.forEach(r=>{const o=document.createElement("option");o.value=r.id;o.textContent=`${r.name} (Lvl ${r.minLvl}+) XP:${r.xpPer} Time:${r.timeSec}s`;sel.appendChild(o);});}

function runCalc(){
console.log("EXP Table:", DATA.levels);
const targetLevel = +el("lvlTarget").value;
console.log(`Level ${targetLevel} XP:`, levelToXP(targetLevel));
console.log(`Level ${targetLevel+1} XP:`, levelToXP(targetLevel+1));  
const skill=el("skillSelect").value;
  if(!skill)return alert("Select a skill first!");
  
  const use=el("useLevel").checked;
  let curExp=use?levelAndPercentToExp(+el("lvlCurrent").value||1,+el("lvlPercent").value||0):(+el("expCurrent").value||0);
  
  // FIXED: Clear distinction between start and end of level
  let tgtExp;
  if(use){
    const targetLevel = +el("lvlTarget").value;
    // We want to reach the START of the target level
    tgtExp = levelToXP(targetLevel);
    
    // Debug: show what we're calculating
    const nextLevelXP = levelToXP(targetLevel + 1);
    console.log(`Target: Level ${targetLevel} (START = ${tgtExp} XP, END = ${nextLevelXP} XP)`);
  } else {
    tgtExp=+el("expTarget").value||0;
  }
  
  if(tgtExp<=curExp)return alert("Target EXP must be higher than current EXP.");
  
  const eff=+el("efficiency").value||100;
  const chosen=el("recipeSelect").value;
  if(!chosen)return alert("Select a recipe or Auto mode.");

  if(chosen!=="auto"){
    const it=DATA.items.find(i=>i.id===chosen&&i.skill===skill);
    if(!it)return alert("Recipe not found!");
    const need=Math.ceil((tgtExp-curExp)/it.xpPer);
    const t=need*it.timeSec*(100/Math.max(eff,0.1)),b=need*it.timeSec;
    el("outBreakdown").innerHTML=`<div class='breakCard'>üç≥ <strong>${it.name}</strong><br>‚öíÔ∏è Crafts: ${need.toLocaleString()}<br>‚è±Ô∏è ${formatTime(t)} (eff ${eff}%)<br>üìà XP: ${(tgtExp-curExp).toLocaleString()}</div>`;
    el("outTotals").textContent=`Items: ${need.toLocaleString()} ‚Ä¢ Recipe: ${it.name}`;
    el("outTimeBase").textContent=`Time: ${formatTime(t)} ‚Ä¢ Base: ${formatTime(b)}`;
    const r=getRecipeIngredients(it.id,need,DATA.recipes,DATA.itemNameMap);
    el("outResources").innerHTML=Object.entries(r).map(([n,q])=>`<div class="resourceItem">${n}: ${q.toLocaleString()}</div>`).join("")||"None";
    el("status").textContent="Done ‚úÖ";
    return;
  }

// AUTO MODE - Fixed to calculate to START of target level
const items=DATA.items.filter(i=>i.skill===skill&&i.xpPer>0).sort((a,b)=>a.minLvl-b.minLvl);
let cur=curExp;const target=tgtExp; // target is now START of target level
let breakdownHTML="";let totalItems=0,totalT=0,totalBase=0,totalRes={};let iter=0;

while(cur<target&&iter<999){iter++;const lvl=expToLevel(cur);
const avail=items.filter(r=>r.minLvl<=lvl);if(!avail.length)break;
const best=avail.map(r=>({...r,t:r.timeSec/r.xpPer})).sort((a,b)=>a.t-b.t)[0];

// Find next unlock level - we want to switch recipes as soon as we hit the level
const nextUnlock=items.map(r=>r.minLvl).filter(l=>l>lvl).sort((a,b)=>a-b)[0];
const limitXP=isFinite(nextUnlock)?levelToXP(nextUnlock):target; // Switch at start of next level

const until=Math.min(target,limitXP);let needXP=until-cur;if(needXP<=0){
  if(isFinite(nextUnlock))cur=levelToXP(nextUnlock);else break;continue;}

let crafts=Math.ceil(needXP/best.xpPer);if(best.xpPer<=0)break;
let xpGain=crafts*best.xpPer;

// Don't overshoot our target (start of target level)
if(cur+xpGain>target){xpGain=target-cur;crafts=Math.ceil(xpGain/best.xpPer);}

const timeForCrafts=crafts*best.timeSec*(100/Math.max(eff,0.1));const baseTimeForCrafts=crafts*best.timeSec;
totalItems+=crafts;totalT+=timeForCrafts;totalBase+=baseTimeForCrafts;
const resources=getRecipeIngredients(best.id,crafts,DATA.recipes,DATA.itemNameMap);for(const k in resources)totalRes[k]=(totalRes[k]||0)+resources[k];
const startLevel=lvl;const endLevel=expToLevel(cur+xpGain);
breakdownHTML+=`<div class='breakCard'>üç≥ <strong>${best.name}</strong><br>üìä Lvl ${startLevel}‚Üí${endLevel}<br>‚öíÔ∏è Crafts: ${crafts.toLocaleString()}<br>‚è±Ô∏è ${formatTime(timeForCrafts)}</div>`;
cur+=xpGain;if(cur>=target)break;}

// Display auto mode results with icons
el("outBreakdown").innerHTML=breakdownHTML||"No breakdown available";
el("outTotals").textContent=`Total crafts: ${totalItems.toLocaleString()} ‚Ä¢ Time: ${formatTime(totalT)}`;
el("outTimeBase").textContent=`Eff ${eff}% ‚Ä¢ Base time: ${formatTime(totalBase)}`;
el("outResources").innerHTML=Object.entries(totalRes).sort((a,b)=>b[1]-a[1]).map(([n,q])=>`<div class="resourceItem">${n}: ${q.toLocaleString()}</div>`).join("")||"None";
el("status").textContent=iter>=999?"Stopped (iteration limit)":"Done ‚úÖ";}

function formatTime(secs){if(!isFinite(secs))return"‚Äî";const t=Math.round(secs),h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;if(h)return`${h}h ${m}m`;if(m)return`${m}m ${s}s`;return`${s}s`;}

el("calcBtn").addEventListener("click",runCalc);
el("sheetId").value=DEFAULT_SHEET_ID;
loadAll(DEFAULT_SHEET_ID);
</script>
</body>
</html>